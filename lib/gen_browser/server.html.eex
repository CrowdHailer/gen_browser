<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
</head>
<body>
  <h1>Hi</h1>
  <ul id="messages"></ul>
  <ul id="your_pair"></ul>
  <button onclick="sendMessage(window.pair_up, {pair_me: window.self, display_name: 'dan'})">Pair up</button>
  <button onclick="sendMessage(window.pair, {message: 'Hello'})">Send</button>
  <script type="text/javascript">
    var $message = document.getElementById('messages')
    var $your_pair = document.getElementById('your_pair')
    displayUpdate = function (text) {
      var line = "<li>" + text +"</li>"
      $message.innerHTML = line + $message.innerHTML
    }

    console.log('Hello')
    var eventSource = new EventSource("http://localhost:8080/mailbox")
    eventSource.addEventListener('gen_browser', function (event) {
      var {self, config, pair_up} = JSON.parse(event.data)
      window.self = self
      window.logger = config.logger
      window.pair_up = config.pair_up
    })
    eventSource.addEventListener('message', function (event) {

      var data = JSON.parse(event.data)
      console.log(data)
      if (data.your_pair) {
        console.log('paired with', data.your_pair)
        window.pair = data.your_pair
        your_pair.innerHTML = data.your_pair
      }
      if (data.message) {
        displayUpdate(data.message)
      }
    })

    function sendMessage(address, data) {
      fetch('http://localhost:8080/mailbox/' + address, {
        method: 'POST',
        body: JSON.stringify(data),
        mode: 'no-cors'
      })
    }
  </script>
</body>
</html>
