<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>BFF</title>
</head>
<body>
  <h2>Your pair <span id="your_pair"></span></h2>
  <button type="button" onclick="getPartner()">Pair Up</button>
  <hr>
  <input type="text" id="message" placeholder="Send a Message">
  <button onclick="sendYourMessage()">Send your Message</button>
  <h2>Messages</h2>
  <ul id="messages"></ul>
  <script type="text/javascript" src="/_gen_browser/page.js"></script>
  <script type="text/javascript">
    var $messages = document.getElementById('messages')
    var $message = document.getElementById('message')
    var $your_pair = document.getElementById('your_pair')

    displayUpdate = function (text) {
      var line = "<li>" + text +"</li>"
      $messages.innerHTML = line + $messages.innerHTML
    }

    var client = new GenBrowser({
      init: function(state){
        console.log('Page started', state)
        return state
      },
      handle_info: function(message, state){
        console.log('Message received', message)
        if (message.your_pair) {
          state.pair = message.your_pair
          $your_pair.textContent = message.your_pair
        }
        if (message.text) {
          displayUpdate(message.text)
        }
        return state
      }
    })

    function getPartner(){
      client.send(client.state.pair_up, {pair_me: client.address})
    }

    function sendYourMessage() {
      if (!client.state.pair) {
        return alert('You need a partner, pair up')
      }

      client.send(client.state.pair, {text: $message.value})
      $message.value = ''
    }
  </script>
</body>
</html>
